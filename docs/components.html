<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>1&nbsp; Model components – mrgsolve user guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./specification.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-892ecacd3d0a7b5a55dc40f7c2b1c458.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./components.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Model components</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">mrgsolve user guide</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./components.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Model components</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./specification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Model specification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./read-write.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Read and write models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Input data sets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./event.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Event objects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Model Matrices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./output.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Simulated output</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sequence.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Simulation sequence</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./steady-state.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Steady state</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./plugins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Plugins</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mtime.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Modeled events</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./topics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Topics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./q-and-a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Questions and Answers</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Installation</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-component-param" id="toc-sec-component-param" class="nav-link active" data-scroll-target="#sec-component-param"><span class="header-section-number">1.1</span> Parameter list</a>
  <ul class="collapse">
  <li><a href="#central-role-of-parameters-in-planning-simulations" id="toc-central-role-of-parameters-in-planning-simulations" class="nav-link" data-scroll-target="#central-role-of-parameters-in-planning-simulations"><span class="header-section-number">1.1.1</span> Central role of parameters in planning simulations</a></li>
  </ul></li>
  <li><a href="#sec-component-init" id="toc-sec-component-init" class="nav-link" data-scroll-target="#sec-component-init"><span class="header-section-number">1.2</span> Compartment list</a></li>
  <li><a href="#sec-component-stime" id="toc-sec-component-stime" class="nav-link" data-scroll-target="#sec-component-stime"><span class="header-section-number">1.3</span> Simulation time grid</a>
  <ul class="collapse">
  <li><a href="#sec-component-tgrid" id="toc-sec-component-tgrid" class="nav-link" data-scroll-target="#sec-component-tgrid"><span class="header-section-number">1.3.1</span> <code>tgrid</code> objects</a></li>
  </ul></li>
  <li><a href="#solver-settings" id="toc-solver-settings" class="nav-link" data-scroll-target="#solver-settings"><span class="header-section-number">1.4</span> Solver settings</a>
  <ul class="collapse">
  <li><a href="#atol" id="toc-atol" class="nav-link" data-scroll-target="#atol"><span class="header-section-number">1.4.1</span> <code>atol</code></a></li>
  <li><a href="#rtol" id="toc-rtol" class="nav-link" data-scroll-target="#rtol"><span class="header-section-number">1.4.2</span> <code>rtol</code></a></li>
  <li><a href="#custom-rtol-and-atol" id="toc-custom-rtol-and-atol" class="nav-link" data-scroll-target="#custom-rtol-and-atol"><span class="header-section-number">1.4.3</span> Custom <code>rtol</code> and <code>atol</code></a></li>
  <li><a href="#maxsteps" id="toc-maxsteps" class="nav-link" data-scroll-target="#maxsteps"><span class="header-section-number">1.4.4</span> <code>maxsteps</code></a></li>
  <li><a href="#hmax" id="toc-hmax" class="nav-link" data-scroll-target="#hmax"><span class="header-section-number">1.4.5</span> <code>hmax</code></a></li>
  <li><a href="#hmin" id="toc-hmin" class="nav-link" data-scroll-target="#hmin"><span class="header-section-number">1.4.6</span> <code>hmin</code></a></li>
  <li><a href="#ixpr" id="toc-ixpr" class="nav-link" data-scroll-target="#ixpr"><span class="header-section-number">1.4.7</span> <code>ixpr</code></a></li>
  <li><a href="#mxhnil" id="toc-mxhnil" class="nav-link" data-scroll-target="#mxhnil"><span class="header-section-number">1.4.8</span> <code>mxhnil</code></a></li>
  </ul></li>
  <li><a href="#sec-model-functions" id="toc-sec-model-functions" class="nav-link" data-scroll-target="#sec-model-functions"><span class="header-section-number">1.5</span> Functions &nbsp;</a>
  <ul class="collapse">
  <li><a href="#the-preamble-function" id="toc-the-preamble-function" class="nav-link" data-scroll-target="#the-preamble-function"><span class="header-section-number">1.5.1</span> The <code>$PREAMBLE</code> function</a></li>
  <li><a href="#the-main-function" id="toc-the-main-function" class="nav-link" data-scroll-target="#the-main-function"><span class="header-section-number">1.5.2</span> The <code>$MAIN</code> function</a></li>
  <li><a href="#the-ode-function" id="toc-the-ode-function" class="nav-link" data-scroll-target="#the-ode-function"><span class="header-section-number">1.5.3</span> The <code>$ODE</code> function</a></li>
  <li><a href="#the-table-function" id="toc-the-table-function" class="nav-link" data-scroll-target="#the-table-function"><span class="header-section-number">1.5.4</span> The <code>$TABLE</code> function</a></li>
  </ul></li>
  <li><a href="#random-effect-variances" id="toc-random-effect-variances" class="nav-link" data-scroll-target="#random-effect-variances"><span class="header-section-number">1.6</span> Random effect variances</a>
  <ul class="collapse">
  <li><a href="#omega" id="toc-omega" class="nav-link" data-scroll-target="#omega"><span class="header-section-number">1.6.1</span> <code>OMEGA</code></a></li>
  <li><a href="#sigma" id="toc-sigma" class="nav-link" data-scroll-target="#sigma"><span class="header-section-number">1.6.2</span> <code>SIGMA</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-model-components" class="quarto-section-identifier"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Model components</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter details the different components of a model in <code>mrgsolve</code>. Each component listed here is maintained within a “model object”. This is an updatable S4 object in <code>R</code> that contains all of the basic information required to properly configure and simulate from the model.</p>
<section id="sec-component-param" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="sec-component-param"><span class="header-section-number">1.1</span> Parameter list</h2>
<p>The parameter list is an updatable set of name-value pairs. Referencing the name of an item in the parameter list will substitute the current value associated with that name. While the name “parameter” may have a certain connotation in the modeling world, in <code>mrgsolve</code> a “parameter” could be any category of numeric data: covariates (e.g.&nbsp;<code>WT</code>, <code>AGE</code>, <code>SEX</code>), flags, other numeric data that we commonly call “parameter” (e.g.&nbsp;<code>CL</code> or <code>VC</code>).</p>
<p>The parameter list is declared in the code block <code>$PARAM</code>. While there may be multiple <code>$PARAM</code> blocks in a model, these are condensed to a single parameter list stored in the model object. The names and numbers of all parameters in the model must be declared at the time that the model is compiled. Also, a default value for each parameter must be declared at model compile time, but the value of each parameter may be updated in one of several ways.</p>
<p>The parameters in a model object can be queried or updated with the <code>param()</code> function.</p>
<p>See also: <a href="specification.html#sec-block-param" class="quarto-xref"><span>Section 2.2.4</span></a>, <code>?param</code> in the <code>R</code> help system after loading <code>mrgsolve</code>.</p>
<section id="central-role-of-parameters-in-planning-simulations" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="central-role-of-parameters-in-planning-simulations"><span class="header-section-number">1.1.1</span> Central role of parameters in planning simulations</h3>
<p>The data items in the parameter list are more than just values associated with a name. When an name is added to the parameter list, that name becomes a key word that <code>mrgsolve</code> will start to recognize in input data sets or when manipulating the model object.</p>
<p>For example, when you want to include a covariate in the model, say weight (<code>WT</code>), you’ll include a column in the data set called <code>WT</code> that will indicate the weight of this or that patient. It is crucial that you also list <code>WT</code> in <code>$PARAM</code> with some default value. It helps if that value is sensible too. When <code>mrgsolve</code> receives the data set prior to simulating, the <code>WT</code> column is matched up with the <code>WT</code> parameter name. As <code>mrgsolve</code> works its way through the input data set (from person to person or from time to time), the value of <code>WT</code> is updated so that the symbol <code>WT</code> in <code>$MAIN</code> or <code>$ODE</code> or <code>$TABLE</code> always points to the value of <code>WT</code>. If the <code>WT</code> name is not in the parameter list, it won’t matter if it is in the data set or not. Only listing a name in <code>$PARAM</code> gets it “into the game”.</p>
<p>Understanding the parameter update mechanism is very important for planning complicated simulations with <code>mrgsolve</code>. Please see the information in <a href="datasets.html#sec-datasets" class="quarto-xref"><span>Section 4.1</span></a> and in <a href="topics.html#sec-topic-parameter-update" class="quarto-xref"><span>Section 12.3</span></a>.</p>
</section>
</section>
<section id="sec-component-init" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="sec-component-init"><span class="header-section-number">1.2</span> Compartment list</h2>
<p>Like the parameter list, the compartment list is a series of name-value pairs. The compartment list defines the number, names, and initial values of each compartment in the model. The names, numbers, and order of the compartment in a model is established at the time of model compile and changes to the compartment list require re-compilation of the model.</p>
<p>Compartments are declared in one of two code blocks: <code>$INIT</code> and <code>$CMT</code>. Nominal initial values must be supplied for each compartment. The main difference between <code>$INIT</code> and <code>$CMT</code> is that <code>$CMT</code> assumes a default initial value of 0 for each compartment; thus only compartment names are entered. When using <code>$INIT</code>, both names and values must be explicitly stated for each compartment.</p>
<p>The initial values for each compartment can be queried with the <code>init()</code> function. There are several different ways to set the initial conditions in a model; <a href="topics.html#sec-topic-init" class="quarto-xref"><span>Section 12.2</span></a> illustrates several of these.</p>
<p>See also: <a href="topics.html#sec-topic-init" class="quarto-xref"><span>Section 12.2</span></a> and <code>?init</code> in the <code>R</code> help system after loading <code>mrgsolve</code>.</p>
</section>
<section id="sec-component-stime" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="sec-component-stime"><span class="header-section-number">1.3</span> Simulation time grid</h2>
<p>The <code>mrgsolve</code> model object stores the parameters for the series of time points to be output for a a simulation. This is the default output time grid that will be used if not over-ridden by another mechanism.</p>
<p>The elements of the simulation time grid are: <code>start</code>, <code>end</code>, <code>delta</code> and <code>add</code>. <code>start</code>, <code>end</code>, <code>delta</code> are passed to <code>seq()</code> as <code>from</code>, <code>to</code>, and <code>by</code>, respectively. <code>add</code> is any arbitrary vector of additional times to simulate.</p>
<p>The simulation time grid in a model object may be queried with the <code>stime()</code> function or by printing the model object to the <code>R</code> console.</p>
<p>See also <a href="datasets.html#sec-data-set" class="quarto-xref"><span>Section 4.2</span></a> for discussion of the simulation time grid and input data sets and <a href="#sec-component-tgrid" class="quarto-xref"><span>Section 1.3.1</span></a> and <a href="topics.html#sec-topic-tgrid" class="quarto-xref"><span>Section 12.4</span></a> for using time grid objects .</p>
<section id="sec-component-tgrid" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="sec-component-tgrid"><span class="header-section-number">1.3.1</span> <code>tgrid</code> objects</h3>
<p>A <code>tgrid</code> object has <code>start</code>, <code>end</code>, <code>delta</code> and <code>add</code> attributes. This object is independent of the model object. <code>tgrid</code> objects may be created and combined to create complex sampling designs.</p>
<p>See <a href="topics.html#sec-topic-tgrid" class="quarto-xref"><span>Section 12.4</span></a> for examples and usage.</p>
</section>
</section>
<section id="solver-settings" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="solver-settings"><span class="header-section-number">1.4</span> Solver settings</h2>
<p><code>mrgsolve</code> uses the <code>DLSODA</code> solver like the one from <code>ODEPACK</code>. Several of the settings for that solver are stored in the model object and passed to the solver when the problem is started. Settings include: <code>atol</code>, <code>rtol</code>, <code>maxsteps</code>, <code>hmax</code>, <code>hmin</code>, <code>ixpr</code>, <code>mxhnil</code>.</p>
<p>Solver settings can be changed through the <code>update()</code> method for your mrgsolve model object. For example, to change <code>rtol</code> to <code>1e-5</code>, write</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">update</span>(mod, <span class="at">rtol =</span> <span class="fl">1e-5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where <code>mod</code> is your mrgsolve model object.</p>
<section id="atol" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="atol"><span class="header-section-number">1.4.1</span> <code>atol</code></h3>
<p>Absolute tolerance parameter. Adjust this value lower when you see state variables (compartments) that are becoming very small and possibly turning negative. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">modlib</span>(<span class="st">"viral1"</span>, <span class="at">end =</span> <span class="dv">144</span>) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">mrgsim_e</span>(mod, <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">1000</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(V <span class="sc">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>. # A tibble: 12 × 8
.       ID  time expos        T         I         V  logV logChange
.    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
.  1     1  95    1000 5187630. -1.79e-11 -1.16e-13   NaN       NaN
.  2     1  97.5  1000 5298189. -1.92e-10 -1.26e-12   NaN       NaN
.  3     1 100    1000 5407830. -2.44e-10 -1.60e-12   NaN       NaN
.  4     1 102.   1000 5516561. -2.75e-10 -1.80e-12   NaN       NaN
.  5     1 105    1000 5624390. -1.78e-10 -1.17e-12   NaN       NaN
.  6     1 108.   1000 5731324. -8.56e-11 -5.60e-13   NaN       NaN
.  7     1 110    1000 5837370. -1.24e-11 -8.12e-14   NaN       NaN
.  8     1 122.   1000 6354547. -1.67e-11 -1.10e-13   NaN       NaN
.  9     1 125    1000 6455421. -1.91e-11 -1.25e-13   NaN       NaN
. 10     1 128.   1000 6555459. -2.11e-11 -1.38e-13   NaN       NaN
. 11     1 130    1000 6654666. -1.23e-11 -8.07e-14   NaN       NaN
. 12     1 132.   1000 6753050. -2.75e-12 -1.82e-14   NaN       NaN</code></pre>
</div>
</div>
<p>Adjusting <code>atol</code> to <code>1E-20</code> or <code>1E-30</code> will prevent this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mrgsim_e</span>(mod, <span class="fu">ev</span>(<span class="at">amt =</span> <span class="dv">1000</span>), <span class="at">atol =</span> <span class="fl">1E-20</span>)  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">%in%</span> out<span class="sc">$</span>time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>. # A tibble: 12 × 8
.       ID  time expos        T        I        V  logV logChange
.    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
.  1     1  95    1000 5187630. 1.33e-11 8.72e-14 -13.1     -18.7
.  2     1  97.5  1000 5298189. 5.13e-12 3.36e-14 -13.5     -19.2
.  3     1 100    1000 5407830. 1.98e-12 1.30e-14 -13.9     -19.6
.  4     1 102.   1000 5516561. 7.66e-13 5.01e-15 -14.3     -20.0
.  5     1 105    1000 5624390. 2.96e-13 1.94e-15 -14.7     -20.4
.  6     1 108.   1000 5731324. 1.15e-13 7.51e-16 -15.1     -20.8
.  7     1 110    1000 5837370. 4.44e-14 2.91e-16 -15.5     -21.2
.  8     1 122.   1000 6354547. 3.94e-16 2.58e-18 -17.6     -23.3
.  9     1 125    1000 6455422. 1.54e-16 1.01e-18 -18.0     -23.7
. 10     1 128.   1000 6555459. 5.99e-17 3.92e-19 -18.4     -24.1
. 11     1 130    1000 6654666. 2.34e-17 1.53e-19 -18.8     -24.5
. 12     1 132.   1000 6753050. 9.14e-18 5.98e-20 -19.2     -24.9</code></pre>
</div>
</div>
<p>Setting <code>atol</code> in this way will apply to <em>every</em> compartment in the model.</p>
</section>
<section id="rtol" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="rtol"><span class="header-section-number">1.4.2</span> <code>rtol</code></h3>
<p>Relative tolerance parameter. Adjust this value lower when you want more precision around the calculation of state variables as the system advances.</p>
<p>Setting <code>rtol</code> in this way will apply to <em>every</em> compartment in the model.</p>
</section>
<section id="custom-rtol-and-atol" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="custom-rtol-and-atol"><span class="header-section-number">1.4.3</span> Custom <code>rtol</code> and <code>atol</code></h3>
<p>Starting with mrgsolve 1.6.1, each compartment can have a customized <code>rtol</code> or <code>atol</code> value.</p>
<p>See the following functions for an overview of the interface for setting these values:</p>
<ul>
<li><code>custom_tol()</code>, <code>custom_rtol()</code>, <code>custom_atol()</code></li>
<li><code>reset_tol()</code> <code>reset_rtol()</code>, <code>reset_atol()</code></li>
<li><code>use_custom_tol()</code>, <code>use_scalar_tol()</code></li>
<li><code>get_tol()</code>, <code>get_tol_list()</code></li>
</ul>
<p>Release notes are here: <a href="https://github.com/metrumresearchgroup/mrgsolve/releases/tag/1.6.0">https://github.com/metrumresearchgroup/mrgsolve/releases/tag/1.6.0</a></p>
</section>
<section id="maxsteps" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="maxsteps"><span class="header-section-number">1.4.4</span> <code>maxsteps</code></h3>
<p>This is the maximum number of steps the solver will take when advancing from one time to the next. If the solver can’t make it in <code>maxsteps</code> it will stop and give an error message like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>DLSODA<span class="op">-</span>  At current T <span class="op">(=</span>R1<span class="op">),</span> MXSTEP <span class="op">(=</span>I1<span class="op">)</span> steps   </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      taken on this call before reaching TOUT     </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>In above message<span class="op">,</span> I <span class="op">=</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="dv">2000</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>In above message<span class="op">,</span> R <span class="op">=</span> </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="fl">0.0004049985</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>DLSODA<span class="op">-</span>  ISTATE <span class="op">(=</span>I1<span class="op">)</span> illegal<span class="op">.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>In above message<span class="op">,</span> I <span class="op">=</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>DLSODA<span class="op">-</span>  Run aborted<span class="op">..</span> apparent infinite loop<span class="op">.</span>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>Error in <span class="op">(</span>function <span class="op">(</span>x<span class="op">,</span> data<span class="op">,</span> idata <span class="op">=</span> null_idata<span class="op">,</span> carry<span class="op">.</span>out <span class="op">=</span> character<span class="op">(</span><span class="dv">0</span><span class="op">),</span>  <span class="op">:</span> </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  error from XERRWD</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You might see this when you have to integrate along time between records in a data set. There isn’t necessarily a problem, but the solver might have to advance over many doses to get to the next record and it only has a limited number of steps it can take between those records before it stops with this error.</p>
<p>When you see this, increase <code>maxsteps</code> to 50000 or larger.</p>
<p>But keep in mind that sometimes the solver can’t make it to the next record because there are issues with the model. It might take thousands of steps to make it 24 hours down the road. In that case, go back to the model code and look for problems in how it is coded.</p>
</section>
<section id="hmax" class="level3" data-number="1.4.5">
<h3 data-number="1.4.5" class="anchored" data-anchor-id="hmax"><span class="header-section-number">1.4.5</span> <code>hmax</code></h3>
<p>The <strong>maximum</strong> step size. By default, the solver will take steps of different sizes based on what is happening in the simulation. Setting <code>hmax</code> tells the solver not to take a step larger than that value. So in a model where <code>time</code> is in hours, reducing <code>hmax</code> to <code>0.1</code> will prevent the solver from taking a step larger than <code>0.1</code> hours as it tries to advance to the next time. The will slow down the simulation a bit. But sometimes helpful when the solver starts taking large steps. We don’t recommend using this routinely; for most applications, it should be reserved for troubleshooting situations. If your model doesn’t give the results that you want without setting <code>hmax</code>, we’d recommend a new setup where this isn’t needed.</p>
</section>
<section id="hmin" class="level3" data-number="1.4.6">
<h3 data-number="1.4.6" class="anchored" data-anchor-id="hmin"><span class="header-section-number">1.4.6</span> <code>hmin</code></h3>
<p>The <strong>minimum</strong> step size. Only set this if you know what you’re doing.</p>
</section>
<section id="ixpr" class="level3" data-number="1.4.7">
<h3 data-number="1.4.7" class="anchored" data-anchor-id="ixpr"><span class="header-section-number">1.4.7</span> <code>ixpr</code></h3>
<p>A flag to enable printing messages to the R console when the solver switches between non-stiff and stiff solving modes. Rarely used.</p>
</section>
<section id="mxhnil" class="level3" data-number="1.4.8">
<h3 data-number="1.4.8" class="anchored" data-anchor-id="mxhnil"><span class="header-section-number">1.4.8</span> <code>mxhnil</code></h3>
<p>The maximum number of messages printed when the model is solving. If you have a lot of messages, keep working on your model code.</p>
</section>
</section>
<section id="sec-model-functions" class="level2" data-number="1.5">
<h2 data-number="1.5" class="anchored" data-anchor-id="sec-model-functions"><span class="header-section-number">1.5</span> Functions &nbsp;</h2>
<p>There are four <code>C++</code> functions that <code>mrgsolve</code> creates and manages: <code>PREAMBLE</code>, <code>MAIN</code>, <code>ODE</code>, <code>TABLE</code>. Each function is created from an entire code block in the model specification file. The user is responsible for writing correct <code>C++</code> code in each of these blocks. mrgsolve will parse these blocks and augment this code with the necessary elements to create the <code>C++</code> function.</p>
<p>These functions may be specified in any order in the model specification file, but there is a <strong>specific calling order</strong> for these functions. Recognizing and understanding this calling order will help understand how the different pieces of the model specification fit together.</p>
<p>Just prior to starting the problem, mrgsolve calls <code>$PREAMBLE</code>. Then, during advance from time <code>T1</code> to <code>T2</code>, first <code>$MAIN</code> is called, then <code>$ODE</code> is called repeatedly as the solver finds the values of state variables at <code>T2</code>, and, once the solution is found, <code>$TABLE</code> is called to calculate derived quantities at <code>T2</code> and to specify variables that should be included in the model output. So, it is helpful to write model specification files in the order:</p>
<ol type="1">
<li><code>$PREAMBLE</code> - called <strong>only once</strong> just prior to processing the first record of the data set</li>
<li><code>$MAIN</code> - <strong>before</strong> advancing the system</li>
<li><code>$ODE</code> - the system <strong>advances</strong> to <code>T2</code></li>
<li><code>$TABLE</code> - <strong>after</strong> advancing the system</li>
</ol>
<p>But the order in which they are coded will not affect model compilation or the simulation result.</p>
<section id="the-preamble-function" class="level3" data-number="1.5.1">
<h3 data-number="1.5.1" class="anchored" data-anchor-id="the-preamble-function"><span class="header-section-number">1.5.1</span> The <code>$PREAMBLE</code> function</h3>
<p>The <code>PREAMBLE</code> function gets called only once, just prior to processing the first record of the data set. This function is composed of <code>C++</code> code and is used to initialize variables and get them set up prior to starting on the problem.</p>
<p>See <a href="specification.html#sec-block-preamble" class="quarto-xref"><span>Section 2.2.15</span></a> for details.</p>
</section>
<section id="the-main-function" class="level3" data-number="1.5.2">
<h3 data-number="1.5.2" class="anchored" data-anchor-id="the-main-function"><span class="header-section-number">1.5.2</span> The <code>$MAIN</code> function</h3>
<p>The <code>MAIN</code> function gets called at least once before the the solver advances from the current time (<code>T1</code>) to the next time (<code>T2</code>). In the <code>MAIN</code> function, the user may:</p>
<ul>
<li>Set initial conditions for any compartment</li>
<li>Derive new variables to be used in the model</li>
<li>Write covariate models</li>
<li>Add between-subject variability to quantities to structural model parameters (e.g.&nbsp;<code>CL</code> or <code>VC</code>).</li>
</ul>
<p>In addition to getting called once per record, the <code>MAIN</code> function may be called several times prior to starting the simulation run. The <code>MAIN</code> function is also called whenever the user queries the compartment list.</p>
<p>mrgsolve allows you access compartment amounts in the <code>MAIN</code> function. But it is important to remember the calling order of these model functions (<a href="#sec-model-functions" class="quarto-xref"><span>Section 1.5</span></a>): because <code>MAIN</code> is called <em>before</em> the system advances, the compartment amounts inside this function will reflect the pre-advance values. This is in contrast to accessing compartment amounts inside the <code>TABLE</code> function, which will reflect the values <em>after</em> the system advances. While there are some use cases where it is useful to check the pre-advance compartment amounts in <code>MAIN</code>, most applications should interact with compartment amounts after the system advances in <code>TABLE</code>.</p>
<p>The <code>MAIN</code> block contains code that is equivalent to the code you’d write in NONMEM’s <code>$PK</code> block. You can use either <code>$MAIN</code> or <code>$PK</code> in your mrgsolve model.</p>
<p>See <a href="specification.html#sec-block-main" class="quarto-xref"><span>Section 2.2.8</span></a> and <a href="specification.html#sec-block-pk" class="quarto-xref"><span>Section 2.2.9</span></a> for details.</p>
</section>
<section id="the-ode-function" class="level3" data-number="1.5.3">
<h3 data-number="1.5.3" class="anchored" data-anchor-id="the-ode-function"><span class="header-section-number">1.5.3</span> The <code>$ODE</code> function</h3>
<p>The <code>ODE</code> function is where the user writes the model differential equations. Any derived quantity that depends on a state variable and is used to advanced the system must be calculated inside <code>$ODE</code>. But, this function is called repeatedly during the simulation run, so any calculation that <strong>can</strong> be moved out of <code>$ODE</code> (for example: to <code>$MAIN</code>) should be.</p>
<p>The <code>ODE</code> block contains code that is equivalent to the code you’d write in NONMEM’s <code>$DES</code> block. You can use either <code>$ODE</code> or <code>$DES</code> in your mrgsolve model.</p>
<p>See <a href="specification.html#sec-block-ode" class="quarto-xref"><span>Section 2.2.10</span></a> and <a href="specification.html#sec-block-des" class="quarto-xref"><span>Section 2.2.11</span></a> for details.</p>
</section>
<section id="the-table-function" class="level3" data-number="1.5.4">
<h3 data-number="1.5.4" class="anchored" data-anchor-id="the-table-function"><span class="header-section-number">1.5.4</span> The <code>$TABLE</code> function</h3>
<p>The <code>TABLE</code> function is called <strong>after</strong> the solver advances in time. The purpose of <code>TABLE</code> is to allow the user to interact with the values of the state variables after advancing, potentially derive new variables, and to insert different outputs into the table of simulated results.</p>
<p>The <code>TABLE</code> block contains code that is equivalent to the code you’d write in NONMEM’s <code>$ERROR</code> block. You can use either <code>$TABLE</code> or <code>$ERROR</code> in your mrgsolve model.</p>
<p>See <a href="specification.html#sec-block-table" class="quarto-xref"><span>Section 2.2.12</span></a> and <a href="specification.html#sec-block-error" class="quarto-xref"><span>Section 2.2.13</span></a> for details.</p>
</section>
</section>
<section id="random-effect-variances" class="level2" data-number="1.6">
<h2 data-number="1.6" class="anchored" data-anchor-id="random-effect-variances"><span class="header-section-number">1.6</span> Random effect variances</h2>
<p>The <code>mrgsolve</code> model object keeps track of a arbitrary number of block matrices that are used to simulate variates from multivariate normal distributions. Users can specify <code>OMEGA</code> matrices for simulating between-subject random effects (one draw per individual) or <code>SIGMA</code> matrices for simulating within-subject random effects (one draw per observation).</p>
<p>See <a href="matrix.html" class="quarto-xref"><span>Chapter 6</span></a> for complete details on how to work with <code>OMEGA</code> and <code>SIGMA</code> in your mrgsolve model.</p>
<section id="omega" class="level3" data-number="1.6.1">
<h3 data-number="1.6.1" class="anchored" data-anchor-id="omega"><span class="header-section-number">1.6.1</span> <code>OMEGA</code></h3>
<p>The matrices are specified in <code>$OMEGA</code> blocks in the model specification file.</p>
<p><code>OMEGA</code> may be queried or updated with the <code>omat()</code> function.</p>
</section>
<section id="sigma" class="level3" data-number="1.6.2">
<h3 data-number="1.6.2" class="anchored" data-anchor-id="sigma"><span class="header-section-number">1.6.2</span> <code>SIGMA</code></h3>
<p>The matrices are specified in <code>$SIGMA</code> blocks in the model specification file.</p>
<p><code>SIGMA</code> may be queried or updated by the <code>smat()</code> function.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./specification.html" class="pagination-link" aria-label="Model specification">
        <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Model specification</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>